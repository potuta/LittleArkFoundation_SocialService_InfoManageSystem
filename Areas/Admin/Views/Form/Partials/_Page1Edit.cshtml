@using LittleArkFoundation.Areas.Admin.Models.Form
@using LittleArkFoundation.Areas.Admin.Models.FamilyComposition
@model FormViewModel

<h2 style="text-align: center;">Edit</h2>
<h2 style="text-align: center;">Republic of the Philippines - Department of Health</h2>
<h3 style="text-align: center;">MSWD Assessment Tool for Children/Adolescent</h3>

<table>
    <tr>
        <td>
            Date of Interview: <span class="required">*</span>
            <input type="date" asp-for="Assessments.DateOfInterview" id="dateInput" style="background-color:#e9ecef; cursor: not-allowed;" readonly required>
            <span asp-validation-for="Assessments.DateOfInterview" class="text-danger"></span>

        </td>
        <td>
            Time of Interview: <span class="required">*</span>
            <input type="time" asp-for="Assessments.TimeOfInterview" id="timeInput" style="background-color:#e9ecef; cursor: not-allowed;" readonly required>
            <span asp-validation-for="Assessments.TimeOfInterview" class="text-danger"></span>

        </td>
    </tr>
    <tr>
        <td>
            Basic Ward: <span class="required">*</span>
            @* <input type="text" asp-for="Assessments.BasicWard" required> *@
            <select asp-for="Assessments.BasicWard" required>
                <option>Ward 2</option>
                <option>Ward 3</option>
                <option>Ward 4</option>
                <option>Ward 5</option>
                <option>Ward 6</option>
                <option>Ward 7</option>
                <option>Ward 8</option>
                <option>Hema</option>
                <option>NICU</option>
                <option>PICU</option>
                <option>Inf.</option>
                <option>OB</option>
            </select>
            <span asp-validation-for="Assessments.BasicWard" class="text-danger"></span>

        </td>
        <td>
            Non-Basic Ward: <span class="required">*</span>
            <input type="text" asp-for="Assessments.NonBasicWard" required>
            <span asp-validation-for="Assessments.NonBasicWard" class="text-danger"></span>

        </td>
    </tr>
    <tr>
        <td>
            Health Record No: <span class="required">*</span>
            <input type="number" asp-for="Assessments.HealthRecordNo" step="any" required>
            <span asp-validation-for="Assessments.HealthRecordNo" class="text-danger"></span>

        </td>
        <td>
            MSWD No: <span class="required">*</span>
            <input type="number" asp-for="Assessments.MSWDNo" step="any" required>

            @* <select asp-for="Assessments.MSWDNo" required>
                @foreach (var user in Model.Users)
                {
                    <option>@user.Username</option>
                }
            </select> *@

            <span asp-validation-for="Assessments.MSWDNo" class="text-danger"></span>

        </td>
    </tr>
</table>

<div class="section-title">Source of Referral</div>
<table>
    <tr>
        <td>
            Referral Name: <span class="required">*</span>
            <select asp-for="Referrals.ReferralType" required>
                <option>Walk in</option>
                <option>Govt. Hosp.</option>
                <option>Private/Clinic</option>
                <option>Health Care Team</option>
                <option>NGO/Private Welfare</option>
                <option>Politicians</option>
                <option>Media</option>
                <option>Govt. Agencies</option>
                <option>Others</option>
            </select>
            <input type="text" asp-for="Referrals.Name" placeholder="Type N/A if no answer" >
            <span asp-validation-for="Referrals.Name" class="text-danger"></span>

        </td>
        <td>
            Address: <span class="required">*</span>
            <input type="text" asp-for="Referrals.Address" required>
            <span asp-validation-for="Referrals.Address" class="text-danger"></span>

        </td>
        <td>
            Contact No: <span class="required">*</span>
            <input type="tel"
                   asp-for="Referrals.ContactNo"
                   inputmode="numeric"
                   pattern="^(0|09\d{9}|0\d{1,2}\d{7,8})$"
                   title="Mobile: 11 digits starting with 09. Or landline e.g. 02xxxxxxx. Or just '0'"
                   maxlength="11"
                   required>

            <span asp-validation-for="Referrals.ContactNo" class="text-danger"></span>

        </td>
    </tr>

</table>

<div class="section-title">Source of Informant</div>
<table>
    <tr>
        <td>
            Informant Name: <span class="required">*</span>
            <input type="text" asp-for="Informants.Name" required>
            <span asp-validation-for="Informants.Name" class="text-danger"></span>

        </td>
        <td>
            Relation to Patient: <span class="required">*</span>
            <input type="text" asp-for="Informants.RelationToPatient" required>
            <span asp-validation-for="Informants.RelationToPatient" class="text-danger"></span>

        </td>
        <td>
            Contact No: <span class="required">*</span>
            <input type="tel" 
                asp-for="Informants.ContactNo"
                inputmode="numeric"
                pattern="^(0|09\d{9}|0\d{1,2}\d{7,8})$"
                title="Mobile: 11 digits starting with 09. Or landline e.g. 02xxxxxxx. Or just '0'"
                maxlength="11"
                required>
            <span asp-validation-for="Informants.ContactNo" class="text-danger"></span>

        </td>
        <td>
            Address: <span class="required">*</span>
            <input type="text" asp-for="Informants.Address" required>
            <span asp-validation-for="Informants.Address" class="text-danger"></span>

        </td>
    </tr>
</table>

<div class="section-title">I. Demographic Data </div>
<table>
    <tr>
        <td>
            Patient's Last Name: <span class="required">*</span>
            <input type="text" asp-for="Patient.LastName" required>
            <span asp-validation-for="Patient.LastName" class="text-danger"></span>
        </td>
        <td>
            Patient's First Name: <span class="required">*</span>
            <input type="text" asp-for="Patient.FirstName" required>
            <span asp-validation-for="Patient.FirstName" class="text-danger"></span>
        </td>
        <td>
            Patient's Middle Name: <span class="required">*</span>
            <input type="text" asp-for="Patient.MiddleName" required>
            <span asp-validation-for="Patient.MiddleName" class="text-danger"></span>
        </td>
    </tr>
    <tr>
        <td>
            Date of Birth: <span class="required">*</span>
            <input type="date" asp-for="Patient.DateOfBirth" required>
            <span asp-validation-for="Patient.DateOfBirth" class="text-danger"></span>
        </td>
        <td>
            Age: <span class="required">*</span>
            <input type="text" asp-for="Assessments.Age"
                   required>
            <span asp-validation-for="Assessments.Age" class="text-danger"></span>
        </td>
        <td>
            Sex: <span class="required">*</span>
            <select asp-for="Patient.Sex" required>
                <option>Male</option>
                <option>Female</option>
            </select>
            <span asp-validation-for="Patient.Sex" class="text-danger"></span>
        </td>
    </tr>
    <tr>
        <td>
            Contact No: <span class="required">*</span>
            <input type="tel" 
                asp-for="Assessments.ContactNo"
                inputmode="numeric"
                pattern="(^09\d{9}$)|(^0\d{1,2}\d{7,8}$)"
                title="Mobile: 11 digits starting with 09. Or landline e.g. 02xxxxxxx"
                maxlength="11"
                required>
            <span asp-validation-for="Assessments.ContactNo" class="text-danger"></span>

        </td>
        <td>
            Place of Birth: <span class="required">*</span>
            <input type="text" asp-for="Patient.PlaceOfBirth" required>
            <span asp-validation-for="Patient.PlaceOfBirth" class="text-danger"></span>

        </td>
        <td>
            Gender: <span class="required">*</span>
            <select asp-for="Assessments.Gender" required>
                <option>Male</option>
                <option>Female</option>
                <option>LGBTQIA+</option>
            </select>
            <span asp-validation-for="Assessments.Gender" class="text-danger"></span>

        </td>
    </tr>
    <tr>
        <td>
            Religion: <span class="required">*</span>
            <input type="text" asp-for="Assessments.Religion" required>
            <span asp-validation-for="Assessments.Religion" class="text-danger"></span>

        </td>
        <td colspan="2">
            Nationality: <span class="required">*</span>
            <input type="text" asp-for="Patient.Nationality" required>
            <span asp-validation-for="Patient.Nationality" class="text-danger"></span>

        </td>
    </tr>
    <tr>
        <td>
            Permanent Address: <span class="required">*</span>
            <input type="text" asp-for="Assessments.PermanentAddress" required>
            <span asp-validation-for="Assessments.PermanentAddress" class="text-danger"></span>

        </td>
        <td colspan="2">
            Temporary Address: <span class="required">*</span>
            <input type="text" asp-for="Assessments.TemporaryAddress" required>
            <span asp-validation-for="Assessments.TemporaryAddress" class="text-danger"></span>

        </td>
    </tr>

    <tr>
        <td>
            Civil Status (Check) <span class="required">*</span>
        </td>
        <td colspan="2">
            <div class="radio-group">
                <div class="radio-group">
                    <input type="radio" asp-for="Assessments.CivilStatus" value="Legitimate" required> Legitimate
                </div>

                <div class="radio-group">
                    <input type="radio" asp-for="Assessments.CivilStatus" value="Illegitimate"> Illegitimate
                </div>

                <div class="radio-group">
                    <input type="radio" asp-for="Assessments.CivilStatus" value="Married"> Married
                </div>

                <div class="radio-group">
                    <input type="radio" asp-for="Assessments.CivilStatus" value="Common Law"> Common Law
                </div>

                <div class="radio-group">
                    <input type="radio" asp-for="Assessments.CivilStatus" value="Widowed"> Widowed
                </div>
                <span asp-validation-for="Assessments.CivilStatus" class="text-danger"></span>
            </div>
        </td>

    </tr>

    <tr>
        <td>
            Highest Educational Attainment <span class="required">*</span>
        </td>
        <td colspan="2">
            <div class="radio-group">
                <input type="radio" asp-for="Assessments.EducationLevel" value="Primary" required> Primary
                <input type="radio" asp-for="Assessments.EducationLevel" value="Secondary"> Secondary
                <input type="radio" asp-for="Assessments.EducationLevel" value="Vocational"> Vocational
                <input type="radio" asp-for="Assessments.EducationLevel" value="Tertiary"> Tertiary
                <input type="radio" asp-for="Assessments.EducationLevel" value="No Educational Attainment"> No Educational Attainment
                <span asp-validation-for="Assessments.EducationLevel" class="text-danger"></span>

            </div>
        </td>
    </tr>

    <tr>
        <td>
            Occupation: <span class="required">*</span>
            <input type="text" asp-for="Assessments.Occupation" required>
            <span asp-validation-for="Assessments.Occupation" class="text-danger"></span>

        </td>
        <td colspan="2">
            Patient's Monthly Income: <span class="required">*</span>
            <input type="number" asp-for="Assessments.MonthlyIncome"
                   min="0"
                   max="99999999.99"
                   step="0.01" required>
            <span asp-validation-for="Assessments.MonthlyIncome" class="text-danger"></span>

        </td>
    </tr>

    <tr>
        <td>
            PhilHealth Identification Number (PIN): <span class="required">*</span>
            <input type="number" asp-for="Assessments.PhilhealthPIN" step="any" required>
            <span asp-validation-for="Assessments.PhilhealthPIN" class="text-danger"></span>

        </td>

        <td colspan="2">
            <div class="radio-group">
                PhilHealth Membership (Check): <span class="required">*</span>
                <div class="radio-group">
                    <input type="radio" asp-for="Assessments.PhilhealthMembership" value="Direct Contributor" required> Direct Contributor
                    <input type="radio" asp-for="Assessments.PhilhealthMembership" value="Indirect Contributor"> Indirect Contributor
                    <span asp-validation-for="Assessments.PhilhealthMembership" class="text-danger"></span>
                </div>
            </div>
        </td>
    </tr>

</table>

<div class="section-title">Family Composition</div>
<table id="family-table">
    <tr>
        <th>Name <span class="required">*</span></th>
        <th>Age <span class="required">*</span></th>
        <th>Date of Birth <span class="required">*</span></th>
        <th>Civil Status <span class="required">*</span></th>
        <th>Relationship to Patient <span class="required">*</span></th>
        <th>Living with Child <span class="required">*</span></th>
        <th>Educational Attainment <span class="required">*</span></th>
        <th>Occupation <span class="required">*</span></th>
        <th>Monthly Income <span class="required">*</span></th>
        <th>Action</th>
    </tr>
    <tbody id="family-body" class="family-input">
        @for (int i = 0; i < Model.FamilyMembers.Count; i++)
        {
            <tr>
                <td><input type="text" asp-for="FamilyMembers[i].Name" required></td>
                <td><input type="text" asp-for="FamilyMembers[i].Age"
                           required>
                </td>
                <td><input type="date" asp-for="FamilyMembers[i].DateOfBirth" required></td>
                <td><input type="text" asp-for="FamilyMembers[i].CivilStatus" required></td>
                <td><input type="text" asp-for="FamilyMembers[i].RelationshipToPatient" required></td>
                <td>
                    <select asp-for="FamilyMembers[i].LivingWithChild" required>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </td>
                <td>
                    <select asp-for="FamilyMembers[i].EducationalAttainment" required>
                        <option value="Master’s Degree">Master’s Degree</option>
                        <option value="College Graduate">College Graduate</option>
                        <option value="College Level">College Level (Undergraduate, not completed)</option>
                        <option value="Vocational Graduate">Vocational Graduate</option>
                        <option value="Senior High School Level">Senior High School Level (not completed)</option>
                        <option value="Senior High School Graduate">Senior High School Graduate</option>
                        <option value="Junior High School Level">Junior High School Level (not completed)</option>
                        <option value="Junior High School Graduate">Junior High School Graduate</option>
                        <option value="Elementary Graduate">Elementary Graduate</option>
                        <option value="Elementary Level">Elementary Level (not completed)</option>
                        <option value="Pre-School">Pre-School</option>
                        <option value="No Schooling">No Schooling</option>
                        <option value="Out of School">Out of School</option>
                        <option value="Illiterate">Illiterate (cannot read and write)</option>
                        <option value="N/A">No Data / Not Specified</option>
                    </select>
                </td>
                <td><input type="text" asp-for="FamilyMembers[i].Occupation" required></td>
                <td>
                    <input type="number" asp-for="FamilyMembers[i].MonthlyIncome" 
                           min="0"
                           max="99999999.99" 
                           step="0.01" required>
                </td>
                <td><button type="button" id="family-button-remove" onclick="removeRow(this)">❌</button></td>
            </tr>
        }
    </tbody>
</table>

<button type="button" id="family-button-add" onclick="addRow(this)">➕ Add Row</button>

<table>
    <tr>
        <td>
            Other Sources of Income: <span class="required">*</span>
            <input type="text" asp-for="Household.OtherSourcesOfIncome" required>
        </td>
        <td>
            Household Size: <span class="required">*</span>
            <input type="number" asp-for="Household.HouseholdSize" required>
        </td>
        <td>
            Total Household Income: <span class="required">*</span>
            <input type="number" asp-for="Household.TotalHouseholdIncome"
                   min="0"
                   max="99999999.99"
                   step="0.01" required>
        </td>
        <td>
            Per Capita Income: <span class="required">*</span>
            <input type="number" asp-for="Household.PerCapitaIncome"
                   min="0"
                   max="99999999.99"
                   step="0.01" readonly>
        </td>
    </tr>
</table>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		const incomeInput = document.getElementById("Household_TotalHouseholdIncome");
		const sizeInput = document.getElementById("Household_HouseholdSize");
		const perCapitaInput = document.getElementById("Household_PerCapitaIncome");

		function computePerCapita() {
			let income = parseFloat(incomeInput.value) || 0;
			let size = parseInt(sizeInput.value) || 0;
			let perCapita = 0;

			if (size > 0) {
				perCapita = income / size;
			}

			// Round to 2 decimals
			perCapita = parseFloat(perCapita.toFixed(2));

			// Enforce DECIMAL(10,2) max value
			const max = 99999999.99; // fits DECIMAL(10,2)
			if (perCapita > max) {
				perCapita = max;
			}

			perCapitaInput.value = perCapita;
		}

		// Run once on page load
		computePerCapita();

		// Update dynamically when income or size changes
		incomeInput.addEventListener("input", computePerCapita);
		sizeInput.addEventListener("input", computePerCapita);
	});
</script>

<div class="section-title">II. MSWD Classification</div>
<table>
    <tr>
        <td>Main Classification:</td>
        <td>
            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MainClassification" value="Financially Capable/Capacitated" required> Financially Capable/Capacitated
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MainClassification" value="Financially Incapable/Incapacitated"> Financially Incapable/Incapacitated
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MainClassification" value="Indigent"> Indigent
            </div>
        </td>
    </tr>
    <tr>
        <td>Sub Classification:</td>
        <td>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.SubClassification" value="C1" disabled> C1
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.SubClassification" value="C2" disabled> C2
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.SubClassification" value="C3" disabled> C3
            </div>
            
        </td>
    </tr>
    <tr>
        <td>Membership to Marginalized Sector (Check)</td>
        <td>
            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Artisanal Fisher Folk" onchange="toggleRequiredRadio(this)" required> Artisanal Fisher Folk
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Farmer And Landless Rural Worker" onchange="toggleRequiredRadio(this)"> Farmer And Landless Rural Worker
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Urban Poor" onchange="toggleRequiredRadio(this)"> Urban Poor
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Indigenous Peoples" onchange="toggleRequiredRadio(this)"> Indigenous Peoples
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Senior Citizen" onchange="toggleRequiredRadio(this)"> Senior Citizen
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Formal Labor and Migrant Workers" onchange="toggleRequiredRadio(this)"> Formal Labor and Migrant Workers
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Workers in Informal Sector" onchange="toggleRequiredRadio(this)"> Workers in Informal Sector
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="PWD" onchange="toggleRequiredRadio(this)"> PWD
            </div>

            <div class="radio-group">
                <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Victims Of Disaster and Calamity" onchange="toggleRequiredRadio(this)"> Victims Of Disaster and Calamity
            </div>

            <div class="radio-group">
                <div class="radio-group">
                    @if (!(new[] { "Artisanal Fisher Folk", "Farmer And Landless Rural Worker", "Urban Poor",
                    "Indigenous Peoples", "Senior Citizen", "Formal Labor and Migrant Workers",
                    "Workers in Informal Sector", "PWD", "Victims Of Disaster and Calamity" })
                    .Contains(Model.MSWDClassification.MembershipSector))
                    {
                        <input type="radio" asp-for="MSWDClassification.MembershipSector" value="@Model.MSWDClassification.MembershipSector"
                               id="others-radio" data-target="member-others-specify"
                               onchange="toggleRequiredRadio(this)" checked>

                        <label>Others</label>

                        <input type="text" id="member-others-specify" placeholder="Specify" disabled
                               asp-for="@Model.MSWDClassification.MembershipSector">
                    }
                    else
                    {
                        <input type="radio" asp-for="MSWDClassification.MembershipSector" value="Others"
                               id="others-radio" data-target="member-others-specify"
                               onchange="toggleRequiredRadio(this)">

                        <label>Others</label>

                        <input type="text" id="member-others-specify" placeholder="Specify" disabled
                               oninput="updateOthersValue(this)">
                    }

                </div>
            </div>
        </td>
    </tr>
</table>

<script>
    function toggleSubRadios() {
        let mainSelected = document.querySelector('input[name="MSWDClassification.MainClassification"]:checked');
        let subRadios = document.querySelectorAll('input[name="MSWDClassification.SubClassification"]');

        if (mainSelected && mainSelected.value === "Financially Incapable/Incapacitated") {
            subRadios.forEach(r => {
                r.disabled = false;
                r.required = true;
            });
        } else {
            subRadios.forEach(r => {
                r.checked = false;   // uncheck if previously selected
                r.disabled = true;
                r.required = false;
            });
        }
    }

    // Attach event listeners
    document.querySelectorAll('input[name="MSWDClassification.MainClassification"]').forEach(mainRadio => {
        mainRadio.addEventListener('change', toggleSubRadios);
    });

    // Run once on page load (important for edit scenarios)
    toggleSubRadios();
</script>

